<?xml version="1.0"?>

<project name="create-flash" default="copy-files" basedir=".">

<property name="flashdrive.dir" location="C:/flashdrive" />
<property name="svn.trunk.folder" value="trunk" />
<property name="svn.caarray.url" value="http://gforge.nci.nih.gov/svnroot/caarray2/" />
<property name="svn.local.trunk" value="${user.home}/caarray2/software" />
<property file="${basedir}/local.properties" />
<property name="svn.tags.folder" value="tags"/>
<property name="buildNumber" value="${svn.tag}"/>
<property name="svn.tags.folder" value="tags"/>

  <taskdef resource="svntask.properties" classpath="${basedir}/lib/svnant.jar;${basedir}/lib/svnClientAdapter.jar;${basedir}/lib/svnjavahl.jar"/>    


<!-- TODO: Run the existing targets below to package the installer -->

<target name="clean">
  <available file="${basedir}/local.properties" property="local.properties.present"/>
  <fail unless="local.properties.present" message="${basedir}/local.properties must be present to generate the installer"/>
  <fail unless="database.system.user" message="${basedir}/local.properties must be present to generate the installer"/>
  <fail unless="database.system.password" message="${basedir}/local.properties must be present to generate the installer"/>
  <delete dir="${flashdrive.dir}" />
  <delete dir="${svn.local.trunk}" />
</target>

<target name="checkout-caarray" unless="use.tag"> 
  <svn username="anonymous" password="">
    <checkout url="${svn.caarray.url}/${svn.trunk.folder}/software" revision="HEAD" destPath="${svn.local.trunk}" />
  </svn>
</target>

<target name="checkout-caarray-tag" if="use.tag">
  <tstamp>
    <format property="touch.time" pattern="MM/dd/yyyy hh:mm aa" unit="hour"/>
   </tstamp>
   <property name="build.date_time" value="touch.time"/>
   <echo message="Checking out caarray from ${svn.caarray.url} using SVN tag ${svn.tag}... build.date_time=${build.date_time} and buildNumber=${buildNumber}" />
   <svn username="anonymous" password="">
     <checkout url="${svn.caarray.url}${svn.tags.folder}/${svn.tag}/software/" destPath="${svn.local.trunk}" />
   </svn>
</target>

<target name="run-build-from-temp">

  <copy file="${basedir}/local.properties" todir="${svn.local.trunk}/build" />
  <ant inheritAll="false" inheritRefs="true" antfile="${svn.local.trunk}/build/build.xml">
    <property name="notest" value="true"/>
  </ant>
  <ant inheritAll="false" inheritRefs="true" antfile="${basedir}/build.xml" target="selfextract"/>
</target>

<target name="create-flash-noco" depends="clean, run-build-from-temp, create-flash" />

<target name="copy-files" depends="clean, checkout-caarray, checkout-caarray-tag, run-build-from-temp, create-flash" /> 

<target name="create-flash">  
  <mkdir dir="${flashdrive.dir}" />
  <unzip dest="${flashdrive.dir}" overwrite="true" src="${basedir}/tools/jdk1.5.0_10.zip" />
  <copy file="${basedir}/install.bat" todir="${flashdrive.dir}" />
  <copy file="${basedir}/README.txt" todir="${flashdrive.dir}" />  
  <copy file="${basedir}/autorun.inf" todir="${flashdrive.dir}" />
  <copy file="${basedir}/target/dist/caarray-installer.jar" todir="${flashdrive.dir}" />
  <copy file="${basedir}/tools/jdk1.5.0_10.zip" todir="${flashdrive.dir}" />
</target>

</project>
