<?xml version="1.0"?>

<project name="create-flash" default="copy-files" basedir=".">

<property name="flashdrive.dir" location="C:/flashdrive" />
<property name="svn.trunk.folder" value="trunk" />
<property name="svn.caarray.url" value="http://gforge.nci.nih.gov/svnroot/caarray2" />
<property name="svn.local.trunk" value="${user.home}/caarray2/software" />
<property file="${basedir}/local.properties" />

<!-- TODO: Run the existing targets below to package the installer -->

<target name="clean">
  <delete dir="${flashdrive.dir}" />
  <delete dir="${svn.local.trunk}" />
</target>

<target name="checkout-caarray"> 
  <!-- TODO: Perform a clean checkout from caArray into a temp dir (like remote build) -->
  <taskdef resource="svntask.properties" classpath="${basedir}/lib/svnant.jar;${basedir}/lib/svnClientAdapter.jar;${basedir}/lib/svnjavahl.jar"/>    
  <svn username="anonymous" password="">
    <checkout url="${svn.caarray.url}/${svn.trunk.folder}/software" revision="HEAD" destPath="${svn.local.trunk}" />
  </svn>
</target>

<target name="run-build-from-temp">
<!-- TODO: Run build from temp.dir (like remote build) -->
<copy file="${basedir}/local.properties" todir="${svn.local.trunk}/build" />
<ant inheritAll="false" inheritRefs="true" antfile="${svn.local.trunk}/build/build.xml">
  <property name="notest" value="true"/>
</ant>
  <!-- TODO: Run installer using the EAR generated -->
<ant inheritAll="false" inheritRefs="true" antfile="${basedir}/build.xml" target="selfextract"/>
</target>

<target name="copy-files" depends="clean, checkout-caarray, run-build-from-temp">
  <available file="${basedir}/local.properties" property="local.properties.present"/>
  <fail unless="local.properties.present" message="${basedir}/local.properties must be present to generate the installer"/>
  <mkdir dir="${flashdrive.dir}" />
  <unzip dest="${flashdrive.dir}" overwrite="true" src="${basedir}/tools/jdk1.5.0_10.zip" />
  <copy file="${basedir}/install.bat" todir="${flashdrive.dir}" />
  <copy file="${basedir}/autorun.inf" todir="${flashdrive.dir}" />
  <copy file="${basedir}/target/dist/caarray-installer.jar" todir="${flashdrive.dir}" />
  <copy file="${basedir}/tools/jdk1.5.0_10.zip" todir="${flashdrive.dir}" />
</target>

</project>
