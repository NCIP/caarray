<!-- *********************************************************************** -->
<!-- ** PROJECT:   caArray                                                ** -->
<!-- *********************************************************************** -->

<project name="caarray" default="build" basedir="..">

    <!-- ******************************************************************* -->
    <!-- ** PROPERTIES                                                    ** -->
    <!-- ******************************************************************* -->

    <!-- Main -->

    <property name="build.dir" value="${basedir}/build" />
    <property name="lib.dir" value="${basedir}/lib" />
    <property name="resource.dir" value="${basedir}/src/main/resources" />
    <property name="target.dir" value="${basedir}/target" />
    <property name="site.dir" value="${target.dir}/site" />

    <!-- Components -->

    <property name="caarray-common.dir" value="${basedir}/caarray-common" />
    <property name="caarray-common.src.dir" value="${caarray-common.dir}/src/main/java" />
    <property name="caarray-common.test.src.dir" value="${caarray-common.dir}/src/test/java" />
    <property name="caarray-common.target.dir" value="${caarray-common.dir}/target" />
    <property name="caarray-common.classes.dir" value="${caarray-common.target.dir}/classes" />
    <property name="caarray-common.test.classes.dir" value="${caarray-common.target.dir}/test-classes" />
    <property name="caarray-common.jar" value="${caarray-common.target.dir}/carray-common.jar" />

    <property name="caarray-ejb.dir" value="${basedir}/caarray-ejb" />
    <property name="caarray-ejb.src.dir" value="${caarray-ejb.dir}/src/main/java" />
    <property name="caarray-ejb.resources.dir" value="${caarray-ejb.dir}/src/main/resources" />
    <property name="caarray-ejb.test.src.dir" value="${caarray-ejb.dir}/src/test/java" />
    <property name="caarray-ejb.target.dir" value="${caarray-ejb.dir}/target" />
    <property name="caarray-ejb.classes.dir" value="${caarray-ejb.target.dir}/classes" />
    <property name="caarray-ejb.test.classes.dir" value="${caarray-ejb.target.dir}/test-classes" />
    <property name="caarray-ejb.jar" value="${caarray-ejb.target.dir}/carray-ejb.jar" />

    <property name="caarray-war.dir" value="${basedir}/caarray-war" />
    <property name="caarray-war.src.dir" value="${caarray-war.dir}/src/main/java" />
    <property name="caarray-war.webapp.dir" value="${caarray-war.dir}/src/main/webapp" />
    <property name="caarray-war.test.src.dir" value="${caarray-war.dir}/src/test/java" />
    <property name="caarray-war.target.dir" value="${caarray-war.dir}/target" />
    <property name="caarray-war.classes.dir" value="${caarray-war.target.dir}/classes" />
    <property name="caarray-war.test.classes.dir" value="${caarray-war.target.dir}/test-classes" />
    <property name="caarray.war" value="${caarray-war.target.dir}/carray.war" />

    <property name="caarray-ear.dir" value="${basedir}/caarray-ear" />
    <property name="caarray-ear.resources.dir" value="${caarray-ear.dir}/src/main/resources" />
    <property name="caarray-ear.target.dir" value="${caarray-ear.dir}/target" />
    <property name="caarray.ear" value="${caarray-ear.target.dir}/carray.ear" />

    <!-- Third-party -->
    <property name="cacore32-client.jar" value="${lib.dir}/cacore32-client.jar" />
    <property name="javaee.jar" value="${lib.dir}/javaee.jar" />
    <property name="checkstyle.jar" value="${lib.dir}/checkstyle-all-4.3.jar" />
    <property name="pmd.jar" value="${lib.dir}/pmd-3.9.jar" />

    <!-- Configuration files -->
    <property name="checkstyle.config" value="${resource.dir}/caarray_checks.xml" />

    <!-- ******************************************************************* -->
    <!-- ** TASKDEFS                                                      ** -->
    <!-- ******************************************************************* -->

    <taskdef resource="checkstyletask.properties" classpath="${checkstyle.jar}" />

    <!-- ******************************************************************* -->
    <!-- ** MAIN TARGETS                                                  ** -->
    <!-- ******************************************************************* -->

    <target name="continuous-integration" depends="clean,build,check,test">
        <fail if="checkstyle.failure" message="There were Checkstyle failures." />
    </target>

    <!-- ******************************************************************* -->
    <!-- ** CLEAN TARGETS                                                 ** -->
    <!-- ******************************************************************* -->

    <target name="clean" depends="clean:caarray-common.jar,
        clean:caarray-ejb.jar,
        clean:caarray.war,
        clean:caarray.ear,
        clean:target.dir" />

    <target name="clean:caarray-common.jar">
        <delete dir="${caarray-common.target.dir}" />
    </target>

    <target name="clean:caarray-ejb.jar">
        <delete dir="${caarray-ejb.target.dir}" />
    </target>

    <target name="clean:caarray.war">
        <delete dir="${caarray-war.target.dir}" />
    </target>

    <target name="clean:caarray.ear">
        <delete dir="${caarray-ear.target.dir}" />
    </target>

    <target name="clean:target.dir">
        <delete dir="${target.dir}" />
    </target>


    <!-- ******************************************************************* -->
    <!-- ** COMPILE TARGETS                                               ** -->
    <!-- ******************************************************************* -->

    <target name="compile" depends="compile:caarray-common.jar,
        compile:caarray-ejb.jar,
        compile:caarray.war" />

    <target name="compile:caarray-common.jar">
        <mkdir dir="${caarray-common.classes.dir}" />
        <javac srcdir="${caarray-common.src.dir}" destdir="${caarray-common.classes.dir}" />
    </target>

    <target name="compile:caarray-ejb.jar" depends="compile:caarray-common.jar">
        <mkdir dir="${caarray-ejb.classes.dir}" />
        <javac srcdir="${caarray-ejb.src.dir}" destdir="${caarray-ejb.classes.dir}">
            <classpath>
                <pathelement location="${caarray-common.classes.dir}" />
                <pathelement location="${cacore32-client.jar}" />
                <pathelement location="${javaee.jar}" />
            </classpath>
        </javac>
    </target>

    <target name="compile:caarray.war" depends="compile:caarray-common.jar,compile:caarray-ejb.jar">
        <mkdir dir="${caarray-war.classes.dir}" />
        <javac srcdir="${caarray-war.src.dir}" destdir="${caarray-war.classes.dir}">
            <classpath>
                <pathelement location="${caarray-common.classes.dir}" />
                <pathelement location="${caarray-ejb.classes.dir}" />
            </classpath>
        </javac>
    </target>

    <!-- ******************************************************************* -->
    <!-- ** BUILD TARGETS                                                 ** -->
    <!-- ******************************************************************* -->

    <target name="build" depends="build:caarray-common.jar,
        build:caarray-ejb.jar,
        build:caarray.war,
        build:caarray.ear" />

    <target name="build:caarray-common.jar" depends="compile:caarray-common.jar">
        <mkdir dir="${caarray-common.target.dir}"/>
        <jar destfile="${caarray-common.jar}">
            <fileset dir="${caarray-common.classes.dir}" />
        </jar>
    </target>

    <target name="build:caarray-ejb.jar" depends="compile:caarray-ejb.jar">
        <mkdir dir="${caarray-ejb.target.dir}"/>
        <jar destfile="${caarray-ejb.jar}">
            <fileset dir="${caarray-ejb.classes.dir}" />
        </jar>
    </target>

    <target name="build:caarray.war" depends="compile:caarray.war">
        <mkdir dir="${caarray-war.target.dir}"/>
        <war destfile="${caarray.war}" webxml="${caarray-war.webapp.dir}/WEB-INF/web.xml">
            <fileset dir="${caarray-war.webapp.dir}">
                <exclude name="WEB-INF/**"/>
            </fileset>
            <classes dir="${caarray-common.classes.dir}" />
            <webinf dir="${caarray-war.webapp.dir}/WEB-INF" >
                <exclude name="web.xml"/>
            </webinf>
        </war>
    </target>

    <target name="build:caarray.ear" depends="build:caarray.war,build:caarray-ejb.jar,build:caarray-common.jar">
        <mkdir dir="${caarray-ear.target.dir}"/>
        <ear destfile="${caarray.ear}" appxml="${caarray-ear.resources.dir}/">
            <include name="${caarray.war}" />
            <include name="${caarray-ejb.jar}" />
            <include name="${caarray-common.jar}" />
        </ear>
    </target>

    <!-- ******************************************************************* -->
    <!-- ** TEST TARGETS                                                  ** -->
    <!-- ******************************************************************* -->

    <target name="test" depends="test:junit" />

    <target name="test:junit" />

    <!-- ******************************************************************* -->
    <!-- ** CHECK TARGETS                                                 ** -->
    <!-- ******************************************************************* -->

    <target name="check" depends="check:checkstyle" />

    <target name="check:checkstyle">
        <mkdir dir="${site.dir}" />
        <checkstyle config="${checkstyle.config}" failureProperty="checkstyle.failure" failOnViolation="false">
            <classpath>
                <pathelement location="${cacore32-client.jar}" />
            </classpath>
            <formatter type="xml" tofile="${site.dir}/checkstyle.xml" />
            <fileset dir="${caarray-common.src.dir}" includes="**/*.java" />
            <fileset dir="${caarray-ejb.src.dir}" includes="**/*.java" />
            <fileset dir="${caarray-war.src.dir}" includes="**/*.java" />
        </checkstyle>
        <style in="${site.dir}/checkstyle.xml"
            out="${site.dir}/checkstyle.html"
            style="${resource.dir}/checkstyle-frames.xsl">
            <param name="output.dir" expression="${site.dir}" />
        </style>
    </target>

    <!-- ******************************************************************* -->
    <!-- ** SITE TARGETS                                                  ** -->
    <!-- ******************************************************************* -->


    <!-- ******************************************************************* -->
    <!-- ** DEPLOY TARGETS                                                ** -->
    <!-- ******************************************************************* -->

</project>