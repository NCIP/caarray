<!-- *********************************************************************** -->
<!-- ** PROJECT:   caArray - remote deployment                            ** -->
<!-- *********************************************************************** -->

<project name="caarray-deploy" default="all" basedir=".">
	
	
	<!-- PROPERTIES -->
	<property file="${build.envpropertyfile}" />
	<property file="local.properties" />
	<property name="lib.dir" value="../lib" />
	
		
	<!-- PATHS -->
    <path id="project.classpath">
       <fileset dir="${lib.dir}">
          <include name="**/*.jar" />
       </fileset>
    </path>
	
	
	<!-- CONDITIONS -->
	<condition property="fail.if.no.env">
		<not>
			<available file="${build.envpropertyfile}" />
		</not>
	</condition>
	
	<condition property="build.with.nolabel.dev">
		<not>
			<isset property="label.ear"/>
		</not>
	</condition>
	
	<condition property="fail.with.nolabel.qa">
		<and>
			<equals arg1="${build.env}" arg2="QA" casesensitive="false"/>
			<not>
				<isset property="label.ear"/>
			</not>
		</and>
	</condition>



   <property name="jsch.jar" value="jsch-0.1.33.jar"/>
   <property name="jsch.jar.location" value="${ant.home}/lib/${jsch.jar}"/>
   <available file="${jsch.jar.location}" property="jsch.jar.present"/>

   	<condition property="fail.if.no.jsch">
		<not>
			<isset property="jsch.jar.present"/>
		</not>
	</condition>
	
	<condition property="build.with.label.dev">
		<and>
			<equals arg1="${build.env}" arg2="DEV" casesensitive="false"/>
			<isset property="label.ear"/>
		</and>
	</condition>
	
	<condition property="build.with.label.qa">
		<and>
			<equals arg1="${build.env}" arg2="QA" casesensitive="false"/>
			<isset property="label.ear"/>
		</and>
	</condition>
	
	
	
	<!-- TARGETS -->
	
	<target name="svn:scorch">
		<echo message="Scorching local SVN working directory ${svn.local.trunk}..." />
		<delete dir="${svn.local.trunk}" />
	</target>
	
	<target name="svn:checkout-caarray">
		<echo message="Checking out latest caarray version from ${svn.caarray.trunk}..." />
		<taskdef resource="svntask.properties" classpathref="project.classpath"/>
		<svn username="anonymous" password="">
			  <checkout url="${svn.caarray.trunk}"
				  revision="HEAD" destPath="${svn.local.trunk}" />
		</svn>
	</target>
	
	<target name="svn:checkout-caarray-ear">
		<echo message="Checking out caarray.ear with label ${label.ear} from ${svn.caarray.trunk}..." />
		<taskdef resource="svntask.properties" classpathref="project.classpath"/>
		<svn username="anonymous" password="">
			  <checkout url="${svn.caarray.trunk}/dist/ear/${label.ear}"
				  revision="HEAD" destPath="${svn.local.trunk}/caarray.ear/target" />
		</svn>
	</target>
	
	<target name="prepare-remote-properties">
		<copy todir="${svn.local.trunk}/build" overwrite="true">
			<fileset dir="." includes="**/*.properties" />
		</copy>
	</target>
	
	<target name="fail-if-no-env" if="fail.if.no.env">
		<fail>Target environment file not found. Please set target environment file with
			-Dbuild.envpropertyfile=[FULLY QUALIFIED PATH TO PROPERTY FILE]</fail>
	</target>

   <target name="fail-if-no-jsch" if="fail.if.no.jsch">
        <copy todir="${ant.home}/lib" overwrite="true">
			<fileset dir="${lib.dir}" includes="${jsch.jar}" />
		</copy>
		<fail>${jsch.jar} must be in your ${ant.home}/lib directory. This file (${jsch.jar}) has been copied to your ${ant.home}/lib directory. IMPORTANT: You must rerun your build script again.</fail>
	</target>

	<target name="fail-if-no-label-qa" if="fail.with.nolabel.qa">
		<fail>QA label not set. Please set the label with -Dlabel.ear=XYZ</fail>
	</target>
	
	<target name="remote-deployment-dev-nolabel" if="build.with.nolabel.dev">
		<antcall target="svn:scorch" />
		<antcall target="svn:checkout-caarray" />
		<antcall target="prepare-remote-properties" />
		<ant inheritAll="false" inheritRefs="true" antfile="${svn.local.trunk}/build/build.xml"
			target="remote-deploy"/>
	</target>
	
	<target name="remote-deployment-dev-label" if="build.with.label.dev">
		<antcall target="svn:scorch" />
		<antcall target="svn:checkout-caarray" />
		<antcall target="prepare-remote-properties" />
		<ant inheritAll="false" inheritRefs="true" antfile="${svn.local.trunk}/build/build.xml"
			target="remote-deploy-label"/>
	</target>
	
	<target name="remote-deployment-qa" if="build.with.label.qa">
		<antcall target="svn:scorch" />
		<antcall target="svn:checkout-caarray" />
		<antcall target="svn:checkout-caarray-ear" />
		<antcall target="prepare-remote-properties" />
		<ant inheritAll="false" inheritRefs="true" antfile="${svn.local.trunk}/build/build.xml"
			target="remote-deploy-qa"/>
	</target>
	
	<target name="all">	   
		<antcall target="fail-if-no-jsch"/>
		<antcall target="fail-if-no-env"/>
		<antcall target="fail-if-no-label-qa"/>
		<antcall target="remote-deployment-dev-nolabel"/>
		<antcall target="remote-deployment-dev-label"/>
		<antcall target="remote-deployment-qa"/>
	</target>
	
</project>