<!-- *********************************************************************** -->
<!-- ** PROJECT:   caarray-cc-nightly                                     ** -->
<!-- *********************************************************************** -->

<project name="caarray-cc-nightly" default="nightly-build" basedir="..">

    <description>
	 This build script is used to invoke the normal build.xml via
	 the delegating-build.xml with the caveat that certain targets within the
	 build.xml need to overridden.
	    -->Why?
	 Certain targets responsible for lauching processes (start jboss)
	 need to use the psexec.exe process to launch the process because CC will block waiting for the process
	 that is started to complete which is not what we want.

	 Default target for this script is 'nightly' which is imported via build.xml
    </description>


    <import file="build.xml"/>
	
	<property name="psexec.exe.cmd" value="${basedir}/build/resources/cruisecontrol/windows/psexec.exe"/>

    <target name="deploy:start-jboss" depends="deploy:check-if-jboss-is-running" unless="jboss.running"
    	description="Override target defined in build.xml to start jboss using PSEXEC.exe">
		<!--
		<echo message="psexec.exe.cmd=${psexec.exe.cmd}"/>
		<echo message="psexec.system.username=${psexec.system.username}" />
		<echo message="psexec.system.password=${psexec.system.password}" />
		<exec executable="${psexec.exe.cmd}" dir="${jboss.home}/bin">
		   <arg line="-u ${psexec.system.username} -p ${psexec.system.password} -d -i -w ${jboss.home}/bin/ ${jboss.home}/bin/run.bat" />
		</exec>
		-->
		<get-next-minute property="next-minute" />
		<exec executable="at">
			  <arg value="${next-minute}" />
			  <arg value="/interactive" />
			  <arg value="${jboss.home}\bin\run.bat" />
		</exec>
		
    </target>

    <target name="nightly-build" depends="continuous-integration,
        deploy:stop-jboss,
        deploy:start-jboss,
        deploy:deploy-and-wait,
        test:functional,
        test:junit-report,
        deploy:stop-jboss,
        test:check-functional-test-results" />

    <target name="test:functional" unless="notest" description="overridden to not fail build immediately on failing tests.">
        <antcall target="test:functional:run-tests"/>
    </target>

    <target name="test:selenium:start-server">
        <echo message="Starting Selenium RC server on port ${selenium.server.port}" />
		<!--
		<exec executable="${psexec.exe.cmd}" dir=".">
		   <arg line="-u ${psexec.system.username} -p ${psexec.system.password} -d -i -w . java -jar ${selenium-server.jar} -port ${selenium.server.port}" />
		</exec>
		-->
		<get-next-minute property="next-minute" />
		<exec executable="at">
			  <arg value="${next-minute}" />
			  <!--arg value="/interactive" /-->
			  <arg value="C:\dev\java_platforms\jdk1.5.0_10\bin\java -jar ${selenium-server.jar} -port ${selenium.server.port}" />
		</exec>
		
    </target>

    <target name="deploy:stop-jboss">
        <java classname="org.jboss.Shutdown" fork="true" spawn="false">
            <arg line="-s ${jboss.server.hostname}:${jboss.server.jndi.port} -S" />
            <classpath>
                <pathelement location="${jboss.home}/bin/shutdown.jar" />
            </classpath>
        </java>
        <sleep seconds="60"/>
    </target>
</project>