<project name="test-build" default="pre-build-checks" basedir=".." xmlns:au="antlib:org.apache.ant.antunit" xmlns="antlib:org.apache.tools.ant">

<property name="lib.dir" value="../lib"/>
<property file="${envpropertyfile}" />
<property file="${basedir}/build/default.properties" />
<property name="antunit.jar" value="ant-antunit-1.0.jar"/>
<property name="antunit.jar.location" value="${lib.dir}/${antunit.jar}"/>
<import file="macrodefs.xml" />

<taskdef uri="antlib:org.apache.ant.antunit"
  resource="org/apache/ant/antunit/antlib.xml">
  <classpath>
    <pathelement location="${antunit.jar.location}"/>
  </classpath>
</taskdef>

  <condition property="isWindows">
    <and>
        <os family="windows"/>
		<not>
   		  <os family="win9x"/>
		</not>
    </and>
  </condition>

<target name="usage">
   <echo>ant -f test-build.xml -Denvpropertyfile=C:\dev\caarray2\software\build\DEV.properties</echo>
</target>

  <target name="setUp">
  </target>

  <target name="test-build" depends="display-properties,setUp,pre-build-checks,tearDown" />

  <target name="test-remote-build" depends="display-properties,setUp,pre-build-checks-command-line,tearDown" />

  <!-- is called after the test, even if that caused an error -->
  <target name="tearDown">
    
  </target>

  <target name="display-properties">
  	  <echo> Diagnostics...</echo>
	  <echoproperties/>
  </target>

  <target name="pre-build-checks" depends="testPortAccess, testEnvPropertyFile, testPropertiesFileExists,testSshKeyFileExists, testSshConnection, testSvnLocalTrunk, testRemoteProtocols" />

  <target name="post-build-checks"/>

  <target name="pre-build-checks-command-line" depends="pre-build-checks, testJavaSecureChannelFileExists, 
    testBuildNoTest" />

  <target name="testEnvPropertyFile">
      <echo> antunit.jar.location is ${antunit.jar.location} </echo>
	<au:assertPropertySet name="envpropertyfile" message="Target environment file not found. Please set target environment file with -Denvpropertyfile=[FULLY QUALIFIED PATH TO PROPERTY FILE]" />  
  </target>

  <target name="testBuildNoTest">
	<au:assertPropertySet name="notest" message="notest is a required system property. Please set this property using -Dnotest=true"/>  
  </target> 

  <target name="testSvnLocalTrunk">
	<au:assertPropertySet name="svn.local.trunk" message="svn.local.trunk property not set."/>  
  </target>

  <target name="testIsWindows">
	<au:assertPropertySet name="isWindows" message="Currently, remote-build.xml only runs on Windows."/>  
  </target>

  <target name="testUpdateEnvironmentProperties">
    <echo>Checking for the existence of the ${svn.local.trunk} and ${scm.private.repo} properties...</echo>
	<au:assertPropertySet name="svn.local.trunk" message="svn.local.trunk is a required property when calling the update-environment-properties target"/>  
	<au:assertPropertySet name="scm.private.repo" message="scm.private.repo is a required property when calling the update-environment-properties target"/>  
  </target>

  <target name="testPropertiesFileExists">
    <echo>Checking for the existing of the ${envpropertyfile} file...</echo>
	<au:assertFileExists file="${envpropertyfile}" message="Unable to find the file: ${envpropertyfile}. The path to -Denvpropertyfile must be fully-qualified." />  
  </target>

  <target name="testSshKeyFileExists">
    <echo>Checking for the existence of the ${ssh.key.file} file...</echo>
	<au:assertFileExists file="${ssh.key.file}" message="Unable to find the file: ${ssh.key.file}. Please update the value of the ssh.key.file attribute in the ${envpropertyfile} file." /> 
  </target>

  <target name="testSshConnection">
    <echo>Testing valid SSH connection to ${ssh.server.username} and ${ssh.grid.username}...</echo>
	    <sshexec port="${ssh.port}" host="${ssh.server.hostname}" trust="true"
          username="${ssh.server.username}" keyfile="${ssh.key.file}"
          passphrase="" verbose="true" command="ls" />
	    <sshexec port="${ssh.port}" host="${ssh.server.hostname}" trust="true"
          username="${ssh.grid.username}" keyfile="${ssh.key.file}"
          passphrase="" verbose="true" command="ls" />
  </target>

  <target name="testJavaSecureChannelFileExists">
    <echo>Checking for the existence of the ${jsch.jar.location} file...</echo>
	<au:assertFileExists file="${jsch.jar.location}" message="Unable to find the file: ${jsch.jar.location}." />  
  </target>

  <target name="testServersOnline" depends="display-properties, testEnvPropertyFile,
  testMySQLOnline, testJBossOnline,testGridServiceOnline, testWebAppOnline "/>

  <target name="testMySQLOnline">
    <echo>Checking ${database.server}:${database.port} (MySQL) availability...</echo>
    <condition property="mysql.running">
      <socket port="${database.port}" server="${database.server}" />
    </condition>
	<au:assertEquals message="Unable to reach ${database.server}:${database.port}" expected="true"
                      actual="${mysql.running}" casesensitive="true"/>
    <echo>${database.server}:${database.port} is Online...</echo>
  </target>

  <target name="testJBossOnline">
    <echo>Checking ${jboss.server.hostname}:${jboss.server.port} (JBoss) availability...</echo>
    <condition property="jboss.running">
      <socket port="${jboss.server.port}" server="${jboss.server.hostname}" />
    </condition>
	<au:assertEquals message="Unable to reach ${jboss.server.hostname}:${jboss.server.port}" expected="true"
                      actual="${jboss.running}" casesensitive="true"/>
    <echo>${jboss.server.hostname}:${jboss.server.port} is Online...</echo>
  </target>

  <target name="testGridServiceOnline">
	<echo>Testing if ${gridservice.url} (Globus) availability...</echo>
	<property name="gridservice.url" value="http://${globoss.server.hostname}:${globoss.server.http.port}/wsrf/services/cagrid/CaArraySvc?wsdl"/>
    <condition property="globus.running">
      <http url="${gridservice.url}"/>
    </condition>
	<au:assertEquals message="Unable to reach ${gridservice.url}" expected="true"
                      actual="${globus.running}" casesensitive="true"/>
    <echo>${gridservice.url} is Online...</echo>
  </target>

  <target name="testWebAppOnline">
    <echo>Checking ${app.url} (Web Application) availability...</echo>  
    <property name="app.url" value="http://${jboss.server.hostname}:${jboss.server.port}/caarray/"/>
	<condition property="webapp.running">
	    <http url="${app.url}"/>
	</condition>	
	<au:assertEquals message="Unable to reach ${app.url}" expected="true"
                      actual="${webapp.running}" casesensitive="true"/>
    <echo>${app.url} is Online...</echo>
  </target>

  <target name="testJndiOnline">
	<echo>Testing if ${jndi.url} (JNDI) availability...</echo>
    <property name="jndi.url" value="http://${jboss.server.hostname}:${jboss.server.jndi.port}"/>
	<condition property="jndi.running">
	    <http url="${jndi.url}"/>
	</condition>
	<au:assertEquals message="Unable to reach ${jndi.url}" expected="true"
                      actual="${jndi.running}" casesensitive="true"/>
    <echo>${jndi.url} is Online...</echo>
  </target>

  <target name="testRemoteProtocols">
	<!--<echo>Testing remote targets in macrodef.xml...</echo>
	<remote-scp remoteScpFileToCopy="${basedir}/build/default.properties" remoteScpToDir="${ssh.server.username}@${ssh.server.hostname}:${jboss.temp.dir}"/>
    <remote-ssh remotesshcommand="ls" />-->
  </target>

  <target name="testPortAccess">
    <echo>Testing access to required ports...</echo>
    <condition property="jboss.server.port.running">
      <socket port="${jboss.server.port}" server="${jboss.server.hostname}" />
    </condition>
    <condition property="jboss.server.jndi.port.running">
      <socket port="${jboss.server.jndi.port}" server="${jboss.server.hostname}" />
    </condition>
    <condition property="database.port.running">
      <socket port="${database.port}" server="${database.server}" />
    </condition>
    <condition property="globoss.server.http.port.running">
      <socket port="${globoss.server.http.port}" server="${globoss.server.hostname}" />
    </condition>
    <condition property="globoss.server.jndi.port.running">
      <socket port="${globoss.server.jndi.port}" server="${globoss.server.hostname}" />
    </condition>
	<!--
    <condition property="mail.smtp.port.running">
      <socket port="${mail.smtp.port}" server="${mail.smtp.host}" />
    </condition>
	-->
	<!-- TODO: Check for LDAP -->

	<!-- DISPLAY ERROR MESSAGES -->
	<au:assertEquals message="Unable to reach ${jboss.server.hostname}:${jboss.server.port}" 
	  expected="true"
	  actual="${jboss.server.port.running}" 
	  casesensitive="true"/>
	<au:assertEquals message="Unable to reach ${jboss.server.hostname}:${jboss.server.port}" 
	  expected="true"
	  actual="${jboss.server.port.running}"
	  casesensitive="true"/>
	<au:assertEquals message="Unable to reach ${database.server}:${database.port}" 
	  expected="true"
	  actual="${database.port.running}"
	  casesensitive="true"/>
	<au:assertEquals message="Unable to reach ${globoss.server.hostname}:${globoss.server.http.port}" 
	  expected="true"
	  actual="${globoss.server.http.port.running}"
	  casesensitive="true"/>
	<au:assertEquals message="Unable to reach ${globoss.server.hostname}:${globoss.server.jndi.port}" 
	  expected="true"
	  actual="${globoss.server.jndi.port.running}"
	  casesensitive="true"/>
	<!--<au:assertEquals message="Unable to reach ${mail.smtp.host}:${mail.smtp.port}" 
	  expected="true"
	  actual="${mail.smtp.port.running}"
	  casesensitive="true"/>-->
  </target>

  <target name="checkLogs">
    <tstamp>
      <format property="touch.time" pattern="MM/dd/yyyy hh:mm aa" unit="hour"/>
    </tstamp>
	<echo> ${touch.time} </echo>
    <exec executable="C:/dev/tools/automation-scripts/fetch-mail.bat" />
    <loadfile srcfile="C:/cygwin/var/spool/mail/Paul.Duvall" property="localBuild">
      <filterchain>
        <linecontains>
          <contains value="Local"/>
        </linecontains>
      </filterchain>
    </loadfile>
    <loadfile srcfile="C:/cygwin/var/spool/mail/Paul.Duvall" property="remoteBuild">
      <filterchain>
        <linecontains>
          <contains value="Remote"/>
        </linecontains>
      </filterchain>
    </loadfile>
    <echo>${kickoffBuild}</echo>
    <delete file="C:/cygwin/var/spool/mail/Paul.Duvall" />
  </target>
  
  <target name="driver" depends="runLocalBuild, runRemoteBuild" />

  <target name="runLocalBuild" depends="checkLogs" if="localBuild">
    <echo>Running the build...</echo>
    <exec executable="cmd" dir="C:\dev\ncicb\caarray2\software\build">
      <arg line="/c ant -f C:\dev\ncicb\caarray2\software\build\build.xml -Dnotest=true -Denvpropertyfile=C:\dev\ncicb\scm-private\trunk\caarray2\properties\DEV.properties -Dnodbintegration=true -DbuildNumber=JottToBuild -Dbuild.date_time='${touch.time}'" />
    </exec>
  </target>

  <target name="runRemoteBuild" depends="checkLogs" if="remoteBuild">
    <echo>Running the build...</echo>
    <exec executable="cmd" dir="C:\dev\ncicb\caarray2\software\build">
      <arg line="/c ant -f C:\dev\ncicb\caarray2\software\build\build.xml remote-deploy -Denvpropertyfile=C:\dev\ncicb\scm-private\trunk\caarray2\properties\DEV.properties -Dnotest=true -Dnodbintegration=true -DbuildNumber=JottToBuild -Dbuild.date_time='${touch.time}'" />
    </exec>
  </target>

</project>